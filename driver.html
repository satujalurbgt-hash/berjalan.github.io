<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Driver - Leaflet</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body, html { margin:0; padding:0; height:100%; font-family:Poppins,sans-serif; }
#map { height: calc(100% - 60px - 60px); width:100%; }

.topbar{
  height:60px; background:#007bff; color:white; display:flex; align-items:center;
  justify-content:space-between; padding:0 15px; box-shadow:0 3px 6px rgba(0,0,0,0.2);
}
.topbar img{ width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover; }
.topbar .user-info{ display:flex; align-items:center; font-weight:600; }
.topbar button{ padding:8px 15px; border:none; border-radius:20px; background:white; color:#007bff; font-weight:600; cursor:pointer; }

.bottom-nav{
  height:60px; background:#007bff; display:flex; align-items:center; justify-content:space-around;
  position:fixed; bottom:0; width:100%; z-index:999; box-shadow:0 -3px 6px rgba(0,0,0,0.2);
}
.bottom-nav button{
  background:none; border:none; color:white; font-size:22px; cursor:pointer; display:flex; flex-direction:column; align-items:center;
}
.bottom-nav button span{ font-size:12px; margin-top:2px; }
.bottom-nav button.active{ color:#ffc107; }
.bottom-nav button:hover{ color:#ffc107; }

#profileModal{
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; transition: opacity 0.3s ease; opacity:0;
}
#profileModal.show{ display:flex; opacity:1; }
#profileModal > div{
  background:white; padding:20px; border-radius:10px; width:300px; text-align:center; 
  position:relative; transform: translateY(-50px); transition: transform 0.3s ease;
}
#profileModal.show > div{ transform: translateY(0); }
#profileModal img{ width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:10px; }
#profileModal button{ padding:10px 15px; border:none; background:#007bff; color:white; border-radius:5px; margin-top:10px; cursor:pointer; }
#closeProfile{ position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold; }

#speedometer{
  position: fixed;
  bottom: 70px;
  left: 10px;
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 999;
  font-size: 16px;
}

#dangerOverlay{
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:red;
  opacity:0.8;
  z-index:2000;
  color:white;
  text-align:center;
  font-size:28px;
  font-weight:bold;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
#dangerOverlay button{
  margin-top:20px;
  padding:15px 30px;
  font-size:24px;
  font-weight:bold;
  background:white;
  color:red;
  border:none;
  border-radius:10px;
  cursor:pointer;
}

@keyframes blink{
  0%,50%,100%{opacity:0.8;}
  25%,75%{opacity:0.3;}
}
</style>
</head>
<body>

<div class="topbar">
  <div class="user-info">
    <img id="driverPhoto" src="https://via.placeholder.com/40">
    <span id="driverName">Driver</span>
  </div>
  <button id="toggleBtn">On</button>
</div>

<div id="map"></div>
<div id="speedometer">0 km/j</div>

<div class="bottom-nav">
  <button id="navHome"><i class="fas fa-home"></i><span>Home</span></button>
  <button id="pesanBtn"><i class="fas fa-car"></i><span>Pesan</span></button>
  <button id="navOrder"><i class="fas fa-car-side"></i><span>Order</span></button>
  <button id="navInfo"><i class="fas fa-info-circle"></i><span>Info</span></button>
  <button id="navProfile"><i class="fas fa-user"></i><span>Profil</span></button>
</div>

<div id="profileModal">
  <div>
    <span id="closeProfile">&times;</span>
    <img id="modalPhoto" src="https://via.placeholder.com/80">
    <h3 id="modalName">Driver Name</h3>
    <p id="modalEmail">Email: example@mail.com</p>
    <p id="modalPhone">Telp: 08123456789</p>
    <button id="modalLogout">Logout</button>
  </div>
</div>

<div id="dangerOverlay">
  <div id="dangerText"></div>
  <button id="safeBtn">Aman</button>
</div>

<audio id="sirenAudio" loop>
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3FQbFF5a91MlASpqImTMmGkYvaTcdxm0",
  authDomain: "kadek-ed34e.firebaseapp.com",
  databaseURL: "https://kadek-ed34e-default-rtdb.firebaseio.com",
  projectId: "kadek-ed34e",
  storageBucket: "kadek-ed34e.appspot.com",
  messagingSenderId: "65756136303",
  appId: "1:65756136303:web:6dbe5bc658fadb05ca1e9a"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const driverKey = localStorage.getItem('driverKey');
if(!driverKey){ alert("Silakan login dulu!"); window.location.href="index.html"; }

const driverRef = ref(db,'drivers/'+driverKey);
onValue(driverRef,snapshot=>{
  const driver = snapshot.val();
  if(driver){
    document.getElementById('driverName').innerText = driver.name;
    document.getElementById('driverPhoto').src = driver.photo || "https://via.placeholder.com/40";
  }
});

// Toggle online/offline
let isOnline = true;
document.getElementById('toggleBtn').onclick = ()=>{
  isOnline = !isOnline;
  document.getElementById('toggleBtn').innerText = isOnline ? "On" : "Off";
  update(driverRef,{online:isOnline});
};

// ----- Leaflet Map -----
let lat=-8.65, lng=115.2167;
const map = L.map('map').setView([lat,lng],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; <a href="https://openstreetmap.org">OpenStreetMap</a>'
}).addTo(map);

let markers={}; // semua marker driver

function createOrUpdateMarker(key, driver){
  if(!driver.lat || !driver.lng) return;
  const pos = [driver.lat, driver.lng];
  const borderColor = driver.online?'green':'red';

  if(markers[key]){
    markers[key].setLatLng(pos);
    markers[key].getElement().style.borderColor = borderColor;
  }else{
    const icon = L.divIcon({
      className:'',
      html:`<div style="width:40px;height:40px;border:3px solid ${borderColor};border-radius:50%;overflow:hidden;box-shadow:0 0 4px rgba(0,0,0,0.5);cursor:pointer">
        <img src="${driver.photo||'https://via.placeholder.com/40'}" style="width:100%;height:100%;object-fit:cover;">
      </div>`,
      iconSize:[40,40]
    });
    const marker = L.marker(pos,{icon}).addTo(map);
    marker.on('click',()=>{
      const popupContent = document.createElement('div');
      popupContent.style.textAlign='center';
      popupContent.innerHTML = `<img src="${driver.photo||'https://via.placeholder.com/50'}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;"><br>
        <b>${driver.name}</b><br>Status: <b>${driver.online?'Online':'Offline'}</b><br>`;
      if(driverKey===key){
        const btn = document.createElement('button');
        btn.innerText="DARURAT";
        btn.style.cssText="padding:5px 10px;margin-top:5px;border:none;background:red;color:white;border-radius:5px;cursor:pointer;font-weight:bold;";
        btn.onclick = ()=> update(driverRef,{danger:true,dangerName:driver.name});
        popupContent.appendChild(btn);
      }else{
        const btn = document.createElement('button');
        btn.innerText="Menuju ke Sini";
        btn.style.cssText="padding:5px 10px;margin-top:5px;border:none;background:#007bff;color:white;border-radius:5px;cursor:pointer;";
        btn.onclick = ()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${driver.lat},${driver.lng}`,'_blank');
        popupContent.appendChild(btn);
      }
      marker.bindPopup(popupContent).openPopup();
    });
    markers[key]=marker;
  }
}

const driversRefAll = ref(db,'drivers');
onValue(driversRefAll,snapshot=>{
  const data = snapshot.val();
  if(data){
    Object.entries(data).forEach(([key,driver])=>{
      createOrUpdateMarker(key,driver);
    });
  }
});

// ----- Speedometer & lokasi sendiri -----
let lastPos=null;
function updateLocation(){
  if(!isOnline) return;
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      lat=pos.coords.latitude;
      lng=pos.coords.longitude;
      const now = Date.now();
      if(lastPos){
        const dt=(now-lastPos.time)/1000;
        const distance=Math.sqrt(Math.pow(lat-lastPos.lat,2)+Math.pow(lng-lastPos.lng,2))*111139;
        const speed=distance/dt*3.6;
        document.getElementById('speedometer').innerText=speed.toFixed(1)+' km/j';
      }
      lastPos={lat,lng,time:now};
      update(driverRef,{lat,lng,lastUpdate:Date.now(),online:isOnline});
    });
  }
}
setInterval(updateLocation,3000);

// ----- Overlay Darurat -----
const dangerOverlay=document.getElementById('dangerOverlay');
const dangerText=document.getElementById('dangerText');
const safeBtn=document.getElementById('safeBtn');
const sirenAudio=document.getElementById('sirenAudio');

safeBtn.onclick = ()=>{
  update(driverRef,{danger:false,dangerName:""});
  dangerOverlay.style.display='none';
  sirenAudio.pause();
  if(navigator.vibrate) navigator.vibrate(0);
};

onValue(driversRefAll,snapshot=>{
  const data = snapshot.val();
  let anyDanger=false;
  let dangerDriver="";
  if(data){
    Object.values(data).forEach(d=>{
      if(d.danger){
        anyDanger=true;
        dangerDriver=d.dangerName||"Driver";
      }
    });
  }
  if(anyDanger){
    dangerOverlay.style.display="flex";
    dangerText.innerText="Segera Bantu "+dangerDriver;
    dangerOverlay.style.animation="blink 1s infinite";
    sirenAudio.play().catch(e=>console.log("Audio play blocked",e));
    if(navigator.vibrate) navigator.vibrate([500,200,500,200]);
  }else{
    dangerOverlay.style.display="none";
    dangerOverlay.style.animation="none";
    sirenAudio.pause();
    if(navigator.vibrate) navigator.vibrate(0);
  }
});

// ----- Modal Profil -----
document.getElementById('navProfile').onclick = ()=>{
  document.getElementById('profileModal').classList.add('show');
};
document.getElementById('closeProfile').onclick = ()=>{document.getElementById('profileModal').classList.remove('show');};
document.getElementById('modalLogout').onclick = ()=>{
  localStorage.removeItem('driverKey'); window.location.href="index.html";
};
</script>
</body>
</html>
